<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="theme.css">
    <title>Introduction √† d3.js</title>

</head>


<h2 id="vid√©o">1. Vid√©o</h2>
<p>Hans Rosling's 200 Countries, 200 Years, 4 Minutes - The Joy of Stats (BBC Four)</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jbkSRLYSojo" frameborder="0" allowfullscreen>
</iframe>
<h2 id="donn√©es">Donn√©es</h2>
<p>Les donn√©es de cette vid√©o sont disponibles sur le site de Gapminder. Source: https://www.gapminder.org/data/</p>
<p>En fouillant un peu on trouve les documents suivants, que l‚Äôon peut t√©l√©charger au format CSV.</p>
<h3 id="gdp-per-capita">GDP per capita</h3>
<p>https://docs.google.com/spreadsheets/d/1RctTQmKB0hzbm1E8rGcufYdMshRdhmYdeL29nXqmvsc/pub?gid=0 http://spreadsheets.google.com/pub?key=1RctTQmKB0hzbm1E8rGcufYdMshRdhmYdeL29nXqmvsc&amp;output=csv</p>
<h3 id="total-population">Total population</h3>
<p>https://docs.google.com/spreadsheets/d/1IbDM8z5XicMIXgr93FPwjgwoTTKMuyLfzU6cQrGZzH8/pub?gid=0 http://spreadsheets.google.com/pub?key=1IbDM8z5XicMIXgr93FPwjgwoTTKMuyLfzU6cQrGZzH8&amp;output=csv</p>
<h3 id="life-expectancy-at-birth">Life expectancy at birth</h3>
<p>https://docs.google.com/spreadsheets/d/1H3nzTwbn8z4lJ5gJ_WfDgCeGEXK3PVGcNjQ_U5og8eo/pub?gid=0 http://spreadsheets.google.com/pub?key=1H3nzTwbn8z4lJ5gJ_WfDgCeGEXK3PVGcNjQ_U5og8eo&amp;output=csv</p>
<p>On observe la structure de ces fichiers : quelle est la ¬´¬†cl√© primaire¬†¬ª ? Comment sont renseign√©es les donn√©es ?</p>
<h1 id="d√©couverte-de-d3.js">2. D√©couverte de d3.js</h1>
<p>Le site d3js.org montre une panoplie d'exemples. Observer, discuter. L'histoire de D3 est assez int√©ressante aussi pour nous journalistes et auteurs de logiciels libres.</p>
<h1 id="utiliser-github-gists-bl.ocks.org-et-blockbuilder.org">3. Utiliser Github, gists, bl.ocks.org et blockbuilder.org</h1>
<p>Pour bien travailler sur le Web il faut en g√©n√©ral un serveur, un √©diteur de texte, etc. On souhaite aussi conserver une trace (un historique) de tout ce que l'on fait, pouvoir faire des modifications et voir les r√©sultats rapidement.</p>
<p>Une approche est d'utiliser un site comme Github, dans lequel on a pouvoir cr√©er des petits projets qui seront imm√©diatement visibles, modifiables en ligne, versionn√©s et archiv√©s.</p>
<p>Sans entrer dans les d√©tails, le mieux est d'essayer tout de go: http://blockbuilder.org/</p>
<p>Ce site est connect√© √† tout l'√©cosyst√®me de <code>d3.js</code>.</p>
<p>Voir ensuite comment cr√©er un compte Github, un gist, et faire le lien entre bl.ocks.org, gists et blockbuilder.</p>
<p>Le bookmarklet s'av√®rera tr√®s pratique !</p>
<h1 id="charger-les-donn√©es-dans-une-page-web">4. Charger les donn√©es dans une page web</h1>
<p>Pour charger des donn√©es dans une page web, il faut passer par le langage Javascript.</p>
<p>Commen√ßons tout de suite par une structure de page Web classique, contenant deux scripts (<a href="page1.html"><code>page1.html</code></a>). L‚Äôun est d3.js, l‚Äôautre un script personnalisable, dans lequel on va pouvoir d√©velopper.</p>
<p>Dans ce script, commen√ßons tout de suite par charger nos donn√©es :</p>
<pre><code>d3.csv(&#39;indicator gapminder population - Data.csv&#39;, function(data) {
    console.log(data);
});</code></pre>
<p>On observe : 1. La page reste vide 2. On ouvre l‚Äôinspecteur 3. il faut que <code>d3.min.js</code> soit pr√©sent 4. Si tout se passe bien, les donn√©es apparaissent dans la console.</p>
<h3 id="que-sest-il-pass√©">Que s‚Äôest-il pass√© ?</h3>
<h4 id="d3.csv"><code>d3.csv</code></h4>
<p><code>d3.csv</code> est une fonction de d3 qui facilite la lecture des fichiers au format CSV. Elle demande au navigateur de charger le fichier dont on lui a donn√© l‚Äôadresse. Elle analyse ensuite le contenu du fichier (un long texte avec des virgules et des sauts de ligne), pour le transformer en une structure de donn√©es. Elle appelle ensuite une fonction de rappel. #### Fonction de rappel Aussi nomm√©e ¬´¬†callback¬†¬ª, cette fonction est appel√©e une fois que <code>d3.csv</code> a fini de charger et d‚Äôanalyser les donn√©es. Elle passe alors cette structure de donn√©es comme argument pour notre fonction. √Ä l‚Äôint√©rieur de la fonction de rappel, la structure de donn√©es est accessible via la variable <code>data</code>. La fonction de rappel est ici une ¬´¬†fonction anonyme¬†¬ª, elle est d√©finie localement, pour un usage unique. Cette fonction fait une seule chose : elle envoie la variable re√ßue √† la fonction <code>console.log</code>.</p>
<p>On observe les donn√©es telles qu‚Äôelles sont affich√©es dans la console.</p>
<ol style="list-style-type: decimal">
<li>Cela se pr√©sente sous la forme d‚Äôune liste d‚Äôobjets Javascript (<code>object</code>)</li>
<li>Chaque objet est une structure comportant plusieurs attributs, dont les cl√©s sont les ann√©es (1950 √† 2015); une cl√© suppl√©mentaire est ¬´¬†Total population¬†¬ª.</li>
<li>Les valeurs sont parfois vides (<code>&quot;&quot;</code>); parfois un nombre entre guillemets (<code>&quot;23098&quot;</code>).</li>
<li>Quant au champ ¬´¬†Total population¬†¬ª, il contient le nom du pays ! C‚Äôest parce que notre CSV n‚Äôest pas parfaitement norm√©. On fera un nouvel ajustement.</li>
</ol>
<p><em>√Ä noter : Formats de fichiers.</em> - d3 offre des outils pour ouvrir d‚Äôautres formats de fichiers pour des donn√©es structur√©es : les principaux sont XML, CSV (et ses variantes TSV de DSV), et JSON. On ne peut pas ouvrir directement un fichier Excel ou LibreOffice. - Mais ce n‚Äôest pas une liste limitative pour autant. Les navigateurs modernes permettent d‚Äôouvrir beaucoup d‚Äôautres types de fichiers. Des images bien s√ªr (avec les technologies SVG ou canvas), mais aussi des fichiers sons ou vid√©o, pour faire du traitement ou des visualisations en direct. - Exemple de traitement d'image¬†: http://bl.ocks.org/mbostock/0d20834e3d5a46138752f86b9b79727e - Exemple de traitement de son avec Audio API : http://bl.ocks.org/eesur/6ad4ee84c81b664353a7</p>
<h1 id="nettoyer-et-pr√©parer-les-donn√©es">5. Nettoyer et pr√©parer les donn√©es</h1>
<p>Comme on a vu pr√©c√©demment, les donn√©es nous arrivent sous forme de nombres entre guillemets. Il va falloir convertir ces valeurs en nombres.</p>
<p>Javascript propose plusieurs m√©thodes pour cela : explicitement <code>parseInt(x)</code> retournera le nombre entier indiqu√© dans la cha√Æne de caract√®re <code>x</code>, et <code>parseFloat(x)</code> la m√™me chose pour un nombre √† virgule.</p>
<p>Mais le plus simple est souvent d‚Äôutiliser la conversion automatique des types : la notation <code>+x</code> transforme la cha√Æne <code>x</code> en nombre.</p>
<p>En observant nos donn√©es de plus pr√®s, on remarque que parfois un nombre comporte une virgule (<code>&quot;10,889&quot;</code>) ‚Äî c‚Äôest le cas du champ 1953 pour l‚Äôobjet 2 ; or ici ce n'est pas un ¬´¬†nombre √† virgule ¬ª (d'ailleurs en notation anglaise la virgule d√©cimale serait rendue par un point), mais simplement une mauvaise saisie.</p>
<p>Bien s√ªr on pourrait retourner dans le fichier source et corriger l'information, mais dans ce cas-ci nous ne pouvons pas y √©crire, seulement lire.</p>
<p>Une mani√®re de convertir en tenant compte de ces deux probl√®mes est la suivante :</p>
<pre><code>function nombre(x) {
    if (!x) return null;
    return +(x.replace(/,/g, &#39;&#39;));
}</code></pre>
<p>La premi√®re ligne renvoie <code>null</code> si la variable <code>x</code> est vide¬†; la seconde convertit son contenu en nombre, apr√®s avoir supprim√© d'√©ventuelles virgules.</p>
<p>Nous sommes maintenant pr√™ts √† nettoyer nos donn√©es.</p>
<p>Commen√ßons par r√©cup√©rer pour chaque pays, son nom, et sa population √† la date 2015 (<a href="page2.html"><code>page2.html</code></a>).</p>
<p>Dans la fonction de rappel de <code>d3.csv</code>, on va traiter la liste de donn√©es <code>data</code> avec la m√©thode <code>.map()</code>. Cette m√©thode emploie une autre fonction de rappel, √† laquelle elle passe un par un les objets de notre liste. Et elle compose une autre liste avec les valeurs renvoy√©es par cette fonction.</p>
<pre><code>    data2 = data
    .map(function(d) {
        var e = {
            nom: d[&#39;Total population&#39;],
            pop2015: nombre(d[2015]),
        };
        return e;
    });
    console.log(data2);</code></pre>
<p>Maintenant que les donn√©es sont charg√©es et analys√©es, il devient possible d'en faire quelque chose.</p>
<p>Commen√ßons par les trier, puis prendre les dix plus gros pays, et les afficher √† l'√©cran.</p>
<pre><code>    data2 = data2.sort(function(a,b) {
        return d3.descending(a.pop2015, b.pop2015);
    })
    .slice(0,10)
    .forEach(function(d) {
        d3.select(&#39;body&#39;)
          .append(&#39;p&#39;)
          .html(d.nom+&#39;: &#39;+d.pop2015);
    })
    ;</code></pre>
<p>La fonction de tri est un peu compliqu√©e : elle appelle une fonction de d3 qui renvoie 1, 0 ou -1 selon l'ordre des valeurs qu'on lui passe. C'est l'√©quivalent de :</p>
<pre><code>if (a.pop2015 &lt; b.pop2015) return -1;
if (a.pop2015 &gt; b.pop2015) return 1;
return 0; // cas de l&#39;√©galit√© entre les deux valeurs</code></pre>
<p>Note: On peut remplacer <code>d3.descending</code> par <code>d3.ascending</code> si on veut trier dans l'ordre croissant.</p>
<p><code>.slice(0,10)</code> nous permet de ne prendre que 10 valeurs en partant de la premi√®re (index = 0).</p>
<p><code>.forEach(‚Ä¶)</code> va faire une boucle sur la liste des 10 r√©sultats, et les passer un par √† sa fonction de rappel.</p>
<p>Celle-ci utilise <code>d3.select</code> pour identifier le <code>body</code> de la page Web, lui rajouter un √©l√©ment <code>p</code> (paragraphe), et lui mettre la cha√Æne de caract√®res (nom + population) comme contenu HTML.</p>
<h1 id="jointure-de-donn√©es-data-binding">6. Jointure de donn√©es (data-binding)</h1>
<p>Cette m√©thode de cr√©ation de nos √©l√©ments visuels (ici, des paragraphes), est un peu fruste. En effet, si on modifie nos donn√©es (par exemple en changeant l'ann√©e de r√©f√©rence), les paragraphes ne vont pas se modifier‚Ä¶</p>
<p>Or c‚Äôest l√† que <code>d3</code> devient puissant : il propose un ensemble de techniques, qui permettent de cr√©er des animations visuelles, ou proposer de l'interaction √† l'utilisateur. Et pour cela, il faut tout d'abord lier les donn√©es aux √©l√©ments visuels.</p>
<p>Cette m√©thode consiste √† remplacer le code pr√©c√©dent par la construction un peu plus abstraite que voici (<a href="page3.html"><code>page3.html</code></a>).</p>
<pre><code>        var pays = d3.select(&#39;body&#39;)
            .selectAll(&#39;p&#39;)
            .data(data2);

        var enter = pays
            .enter()
            .append(&#39;p&#39;);

        enter
            .html(function (d) {
                return d.nom + &#39;: &#39; + d.pop2015;
            });</code></pre>
<h3 id="quest-ce-qui-sest-pass√©">Qu'est-ce qui s'est pass√© ?</h3>
<ul>
<li><code>forEach</code> a disparu : c'est d√©sormais <code>d3</code> qui s'occupe de g√©rer les listes, les boucles etc.</li>
<li><code>d3.select('body')</code> est fait au d√©but, et non dans la boucle : on se positionne d'abord sur le ¬´ conteneur ¬ª dans lequel se trouveront nos √©l√©ments repr√©sentant les donn√©es.</li>
<li><code>.selectAll('p')</code> demande √† <code>d3</code> de faire une s√©lection de tous les paragraphes se trouvant dans notre conteneur. Pour l'instant il n'y en a aucun, notre s√©lection est purement virtuelle.</li>
<li><code>.data(data2)</code> relie nos donn√©es √† cette s√©lection virtuelle. C'est le <em>data-binding</em> : cela indique √† <code>d3</code> qu'on veut avoir un √©l√©ment <code>p</code> par √©l√©ment de la liste de donn√©es <code>data2</code>.</li>
</ul>
<p>√Ä partir de l√†, <code>d3</code> cr√©e un objet (que l'on m√©morise dans la variable <code>pays</code>), qui contient plusieurs sous-s√©lections. Ces sous-s√©lections vont nous permettre de synchroniser nos donn√©es avec les √©l√©ments du graphique. - <code>pays</code>, la s√©lection initiale des √©l√©ments qui sont d√©j√† l√† (vide); - <code>pays.enter()</code> liste les √©l√©ments qui viennent d'arriver et qu'il faut cr√©er; - <code>pays.exit()</code> liste les √©l√©ments qui viennent de partir et qu'il faut supprimer.</p>
<p>Pour le moment, nous n'avons que des √©l√©ments √† cr√©er. (La s√©lection initiale est vide, et il n'y a aucun √©l√©ment qui aurait disparu.)</p>
<p>La s√©quence ci-dessous cr√©e les √©l√©ments en question.</p>
<pre><code>    pays.enter()
        .append(&#39;p&#39;)</code></pre>
<p>La s√©quence qui suit applique une fonction de rappel √† chacun des √©l√©ments. La fonction de rappel re√ßoit la <em>donn√©e associ√©e</em> √† l'√©l√©ment, et le r√©sultat est envoy√© dans son code HTML.</p>
<pre><code>    pays.html(function (d) {
        return d.nom + &#39;: &#39; + d.pop2015;
    })</code></pre>
<p>Le point le plus important est celui-ci : les donn√©es sont d√©sormais enregistr√©es en tant que telles dans les √©l√©ments visuels qui les repr√©sentent. Le lien cr√©√© est solide et permet toutes les manipulations. Et si l'on modifie les donn√©es, l'op√©ration <code>data()</code> sait conserver ces liaisons.</p>
<h1 id="un-exemple-simpliste-dinteraction-avec-les-donn√©es">7. Un exemple (simpliste) d'interaction avec les donn√©es</h1>
<p>Dans cet exemple (<a href="page4.html"><code>page4.html</code></a>), on modifie simplement la cr√©ation des √©l√©ments <code>p</code> :</p>
<pre><code>        pays
            .enter()
            .append(&#39;p&#39;);
            .html(function(d,i) {
               return &#39;pays num√©ro &#39; + i;
            })
            .on(&#39;click&#39;, function (d) {
                var texte = d.nom + &#39;: &#39; + d.pop2015;
                alert( texte );
                this.innerHTML = texte;
            });
</code></pre>
<p>Que s'est-il pass√© ? Simplement, lors de la cr√©ation du paragraphe, on lui donne un code HTML qui indique le rang du pays, et on √©coute l'√©v√©nement &quot;click&quot;.</p>
<p>Si un click est r√©alis√©, la callback est appel√©e, elle re√ßoit comme argument <code>d</code>, la donn√©e associ√©e √† l'√©l√©ment cliqu√©. <code>var texte = d.nom + ': ' + d.pop2015; alert( texte );</code> montre ces donn√©es.</p>
<p><code>this</code> permet de retrouver l'√©l√©ment lui-m√™me, et de le manipuler avec du Javascript normal. Pour un code plus homog√®ne, on peut remplacer cette ligne par <code>d3.select(this).html( texte );</code></p>
<h3 id="observer">Observer</h3>
<p>Avec l'inspecteur, observer les attributs de nos paragraphes, et retrouver l'endroit o√π sont enregistr√©es les donn√©es li√©es aux √©l√©ments <code>p</code>.</p>
<h1 id="visualisation-graphique">8. Visualisation graphique</h1>
<p>Apr√®s les paragraphes, on va repr√©senter nos donn√©es avec des ronds. Pour cela il faut d'abord apprendre √† utiliser SVG.</p>
<p>SVG (pour ‚Äúscalable vector graphics‚Äù) est un format similaire √† HTML, o√π l'on trouve des balises embo√Æt√©es les unes dans les autres. Ces balises ne repr√©sentent pas des paragraphes et des titres, mais des ronds, des traits, des carr√©s, des surfaces‚Ä¶</p>
<p>Les √©l√©ments suivants nous seront utiles : - <code>&lt;svg&gt;</code>: conteneur principal de notre image - attributs importants: <code>width</code>, <code>height</code> (largeur et hauteur) - <code>&lt;g&gt;</code>: groupe d'√©lements, (aussi appel√© ¬´ couche ¬ª ou ¬´¬†calque ¬ª dans le langage des logiciel de graphisme) - attributs importants: <code>transform: translate(x,y)</code> (d√©placer ce groupe de x pixels vers la droite et y vers le bas, √† partir du point (0,0) en haut √† gauche). - <code>&lt;circle&gt;</code>: un cercle, ou un disque - attributs importants: <code>r</code> (rayon); <code>cx, cy</code> (coordonn√©es du centre); <code>fill</code> (couleur de remplissage); <code>stroke</code> (couleur de contour).</p>
<p>SVG en propose bien d'autres : <code>&lt;line&gt;</code>: plusieurs points reli√©s par une ligne, <code>&lt;rect&gt;</code>: rectangle (ou carr√©), etc.</p>
<p>Chaque √©l√©ment graphique de SVG peut √™tre modifi√©, d√©plac√©, mis √† l'√©chelle, colori√© etc, par simple modification des ses attributs ou de son style CSS.</p>
<p>La <a href="page5.html"><code>page5.html</code></a> donne un exemple de contenu SVG.</p>
<p>Observer le code et manipuler les attributs des diff√©rents √©l√©ments dans l'inspecteur pour voir comment ils affectent le graphique.</p>
<h1 id="visualisation-graphique-de-nos-donn√©es">9. Visualisation graphique de nos donn√©es</h1>
<p>Pour faire un graphique avec nos donn√©es, il suffit d√®s lors de combiner les techniques de data-binding de <code>d3</code> avec le format SVG. Ce qui est fait <a href="page6.html"><code>page6.html</code></a></p>
<pre><code>    &lt;svg width=640 height=400&gt;
        &lt;g transform=&quot;translate(320,200)&quot;&gt;&lt;/g&gt;
    &lt;/svg&gt;</code></pre>
<p>Ce morceau de notre page Web d√©finit un SVG, avec un calque positionn√© en son centre.</p>
<pre><code>        pays
            .enter()
            .append(&#39;circle&#39;)
            .attr(&#39;cx&#39;, 0)
            .attr(&#39;cy&#39;, 0)
            .attr(&#39;r&#39;, function (d) {
                    return 0.005 * Math.sqrt(d.pop2015);
                })
            .attr(&#39;fill&#39;, &#39;transparent&#39;)
            .attr(&#39;stroke&#39;, &#39;red&#39;);</code></pre>
<p>Ici au lieu d'ajouter un <code>p</code>on ajoute un cercle, dont le rayon est proportionnel √† la racine carr√©e de la population en 2015. On le rend transparent avec une bordure rouge.</p>
<p>Sans aucun changement, le code qui rendait nos paragraphes clicables rend d√©sormais nos ronds clicables : l'interaction avec SVG se programme exactement comme celle avec HTML.</p>
<h1 id="les-√©chelles">10. Les √©chelles</h1>
<p>Un bout du code pr√©c√©dent s'av√®re particuli√®rement sale : <code>return 0.005 * Math.sqrt(d.pop2015);</code></p>
<p>En effet, il pr√©suppose plusieurs choses: 1. que l'on sait dans quelle √©tendue se trouvent les valeurs de la population (astuce : quel est le pays le plus peupl√©?); 2. Que l'on veut une racine carr√©e (pour que la surface du disque qui figure une population soit proportionnelle √† la population : surface = œÄr<sup>2</sup>); 3. que l'on sait en combien de pixels on doit transformer chaque valeur.</p>
<p>Mais observons le r√¥le de ce bout de code : il s'agit de transformer une dimension num√©rique en une variable visuelle.</p>
<p>Jacques Bertin, le fameux g√©ographe, avait d√©termin√© de fa√ßon scientifique l'ensemble des variables visuelles qu'il √©tait possible d'activer sur un graphique.</p>
<p>Ces dimensions sont les suivantes : - X et Y (les deux dimensions du plan) - TAILLE - VALEUR (intensit√© du clair au fonc√©) - GRAIN (texture) - COULEUR - ORIENTATION (vers le haut, le bas, angle de 30¬∞‚Ä¶) - FORME (carr√©, rond, triangle‚Ä¶)</p>
<p>Le rayon de notre cercle (<code>r</code>) correspond √† la variable visuelle TAILLE. Le bout de code ci-dessus est une fonction qui permet d'affecter une variable visuelle √† une dimension des donn√©es.</p>
<p><code>d3</code> g√©n√©ralise ce principe en d√©finissant des <em>√©chelles</em> (<em>scales</em>), qui ont un domaine (en entr√©e, <em>domain</em>) et une √©tendue (en sortie, <em>range</em>), et convertissent donc des information de leur dimension ¬´¬†donn√©es¬†¬ª √† leur dimension ¬´¬†visuelle¬†¬ª.</p>
<p>Ainsi par exemple on √©crirait de pr√©f√©rence (<a href="page7.html"><code>page7.html</code></a>) :</p>
<pre><code>        var rayon =d3.scaleSqrt()
            .domain([ 0, d3.max(data2, function(d) {
                return d.pop2015;
            }) ])
            .range([ 0, 200 ]);</code></pre>
<p>et puis, plus bas :</p>
<pre><code>           .attr(&#39;r&#39;, function(d) {
                    return rayon(d.pop2015);
                })</code></pre>
<p>Notre graphique est alors d√©fini par des donn√©es, qui sont li√©es √† des √©l√©ments du SVG (ou du HTML) ; des √©chelles permettent de d√©finir, pour chaque √©l√©ment, les variables visuelles qui lui correspondent.</p>
<p>Plusieurs types d'√©chelles sont propos√©s de fa√ßon standard par <code>d3</code>; lin√©aire, logarithmique, √† seuils ; mais aussi des √©chelles de temps (prenant en compte les jours, mois, heure d'hiver etc), ou encore de couleur, o√π l'√©tendue n'est pas un nombre mais un code de couleur HTML.</p>
<p>Une √©chelle tr√®s pratique est <code>d3.scale.category10()</code>. On la d√©couvre <a href="page8.html"><code>page8.html</code></a>. Elle prend en domaine n'importe quelle valeur (ici, le nom du pays), et son √©tendue est une liste de 10 couleurs, qu'elle parcourt dans l'ordre.</p>
<pre><code>       var categorie = d3.scaleOrdinal(d3.schemeCategory10);
‚Ä¶/‚Ä¶
       ‚Ä¶ .attr(&#39;r&#39;, function (d) {
                    return rayon(d.pop2015);
                })
         .attr(&#39;fill&#39;, function (d) {
                    return categorie(d.nom);
                })</code></pre>
<p>Le code suivant vise √† s√©lectionner les ronds dont le rayon serait au moins de 5 pixels; on filtre donc les donn√©es <em>par rapport √† une variable visuelle</em>:</p>
<pre><code>     data2 = data2.filter(function (d) {
                return rayon(d.pop2015) &gt; 5;
            });</code></pre>
<h1 id="sur-ces-principes-construisons-notre-graphique">11. Sur ces principes, construisons notre graphique</h1>
<p>On voit que la construction du graphique se ram√®ne √† deux questions :</p>
<p>Quelles sont les variables visuelles dont nous avons besoin pour la visualisation des pays ? Comment les calculer ?</p>
<p>Comment trouver leurs valeurs ? (Quelles sont les dimensions des donn√©es qui leur correspondent ? Comment les r√©cup√©rer ?)</p>
<h3 id="liste-des-variables-visuelles-des-donn√©es-correspondantes-et-d√©finition-des-√©chelles.">Liste des variables visuelles, des donn√©es correspondantes, et d√©finition des √©chelles.</h3>
<ul>
<li>nom du pays =&gt; texte en survol (pas d'√©chelle)</li>
<li>population =&gt; rayon, √©chelle en racine carr√©e</li>
<li>abscisse =&gt; richesse du pays (PIB per capita), √©chelle logarithmique</li>
<li>ordonn√©e =&gt; esp√©rance de vie (en ann√©es), √©chelle lin√©aire</li>
</ul>
<h3 id="liste-des-dimensions-√†-extraire-des-donn√©es">Liste des dimensions √† extraire des donn√©es</h3>
<ul>
<li>nom du pays (plac√© dans la premi√®re colonne de chaque fichier CSV)</li>
<li>population (valeur √† l'ann√©e t, fichier <code>population.csv</code>)</li>
<li>PIB per capita (valeur √† l'ann√©e t, fichier <code>richesse.csv</code>)</li>
<li>esp√©rance de vie (valeur √† l'ann√©e t, fichier <code>sante.csv</code>)</li>
</ul>
<p>Apr√®s une telle analyse, on se rend compte que notre graphique peut √™tre con√ßu ind√©pendamment des fichiers de donn√©es !</p>
<p>N√©anmoins il va falloir plonger un peu le nez dedans, et on s'aper√ßoit tr√®s vite que la difficult√© est qu'on n'a pas un fichier de donn√©es, mais trois. La <em>callback</em> de <code>d3.csv()</code> ne suffit donc pas √† obtenir toutes les donn√©es dont nous avons besoin.</p>
<p>Une solution serait d'empiler trois callbacks de cette mani√®re :</p>
<pre><code>d3.csv(&#39;population.csv&#39;, function(population) {
    d3.csv(&#39;richesse.csv&#39;, function(richesse) {
       d3.csv(&#39;sante.csv&#39;, function(sante) {
           // ici faire quelque chose avec les trois
           // variables population, richesse, sante
       });
   });
});</code></pre>
<p>Cette approche fonctionne mais n'est pas id√©ale, car elle attend la fin du chargement d'un fichier pour lancer le second chargement, puis le troisi√®me. Par ailleurs c'est un peu ¬´ laid ¬ª.</p>
<p>Mais <code>d3</code> fournit <a href="https://github.com/d3/d3-queue">d3-queue</a>, un outil qui permet de charger de fa√ßon parall√®le plusieurs fichiers (<a href="page9.html"><code>page9.html</code></a>) et d'attendre que tous soient arriv√©s pour lancer une fonction de rappel:</p>
<p><code>&lt;script src=&quot;./queue.v1.js&quot;&gt;&lt;/script&gt;</code></p>
<pre><code>    d3.queue()
        .defer(d3.csv, &#39;population.csv&#39;)
        .defer(d3.csv, &#39;richesse.csv&#39;)
        .defer(d3.csv, &#39;sante.csv&#39;)
        .await(function (error, population, richesse, sante) {
            if (error) throw error;
            console.log(population, richesse, sante);</code></pre>
<p>On voit que cette fonction nous permet un √©ventuel contr√¥le d'erreur (variable <code>error</code>), puis appelle notre callback avec les donn√©es rang√©es dans l'ordre dans lequel on les a d√©clar√©es.</p>
<p>Il ne reste plus qu'√† traiter ces donn√©es pour constituer notre s√©rie statistiques √† la date <code>t</code>.</p>
<p>L√† apparaissent plusieurs difficult√©s: d'une part nos s√©ries de donn√©es sont incompl√®tes (on n'a pas le PIB par habitant en 2015, mais seulement en 2011). D'autre part la liste des pays n'est pas forc√©ment la m√™me. Bref, le nettoyage des donn√©es risque de nous faire mal √† la t√™te.</p>
<p>On applique du code (ci-dessous) pour nettoyer ; ce code met tout ce qu'il faut dans un grande liste <code>data</code> (avec une difficult√© particuli√®re, signal√©e par <code>üå∂</code>).</p>
<pre><code>        var t = 2000;

        var data = d3.map(); // üå∂

        var cle = &#39;Total population&#39;;
        population.forEach(function (d) {
                var nom = d[cle];
                var e = {
                    nom: nom,
                    population: d,
                    pop: valeur(d, 2015)
                };
                data.set(nom, e);
            });

        var cle = &#39;Income per person (fixed 2000 US$)&#39;;
        richesse.forEach(function (d) {
            var nom = d[cle];
            var e = data.get(nom);
            if (e) {
                e.richesse = d;
                data.set(nom, e);
            }
        });

‚Ä¶ (m√™me chose pour la dimension sant√©) ‚Ä¶

// eliminer les pays qui n&#39;ont pas toutes les donnees
// et ceux qui sont trop petits
data = data.values() // üå∂
    .filter(function (d) {
    return d.richesse &gt; 0 &amp;&amp; d.sante &gt; 0 &amp;&amp; d.population &gt; 100000;
});</code></pre>
<h1 id="cr√©er-les-√©chelles">12. Cr√©er les √©chelles</h1>
<p>Maintenant que nous avons notre liste de donn√©es √† afficher, et avons extrait les dimensions, nous pouvons cr√©er les √©chelles pour les transformer en variables visuelles (<a href="page10.html"><code>page10.html</code></a>).</p>
<h3 id="nom-du-pays">nom du pays</h3>
<p>=&gt; texte en survol (pas d'√©chelle) on utilisera ici simplement un <code>&lt;title&gt;</code> en SVG, avec sa syntaxe particuli√®re.</p>
<h3 id="population">population</h3>
<p>=&gt; rayon, √©chelle en racine carr√©e</p>
<pre><code>var rayon =d3.scaleSqrt()
    .domain([0, d3.max(data, function (d) {
        return d.pop;
    })])
    .range([0, 200]);</code></pre>
<h3 id="abscisse-x">abscisse (x)</h3>
<p>=&gt; richesse du pays (PIB per capita), √©chelle logarithmique</p>
<pre><code>var x = d3.scaleLog()
    .domain(d3.extent(data, function (d) {
        return d.richesse;
    }))
    .range([0, 640]);</code></pre>
<h3 id="ordonn√©e">ordonn√©e</h3>
<p>=&gt; esp√©rance de vie (en ann√©es), √©chelle lin√©aire</p>
<pre><code>var y = d3.scaleLinear()
    .domain(d3.extent(data, function (d) {
        return d.sante;
    }))
    .range([0, 400]);</code></pre>
<h3 id="couleur">couleur</h3>
<pre><code>var categorie = d3.scaleOrdinal(d3.schemeCategory10);</code></pre>
<p>On applique alors ces variables visuelles</p>
<pre><code>    .attr(&#39;cx&#39;, function (d) {
            return x(d.richesse);
        })
    .attr(&#39;cy&#39;, function (d) {
            return y(d.sante);
        })
    .attr(&#39;r&#39;, function (d) {
            return rayon(d.pop);
        })
    .attr(&#39;fill&#39;, function (d) {
            return categorie(d.nom);
        })</code></pre>
<p>c'est un peu le bazar, mais on retrouve bien nos pays !</p>
<p>Dans la <a href="page11.html"><code>page11.html</code></a>, on fait quelques tout petits ajustements :</p>
<p>On agrandit le SVG et le premier groupe <code>g</code> sert √† faire des marges de 30px :</p>
<pre><code>-    &lt;svg width=640 height=400&gt;
-        &lt;g transform=&quot;translate(320,200)&quot;&gt;&lt;/g&gt;
+    &lt;svg width=680 height=420&gt;
+        &lt;g transform=&quot;translate(30,30)&quot;&gt;&lt;/g&gt;</code></pre>
<p>Le rayon des cercles devient moins d√©lirant :</p>
<pre><code>          rayon ‚Ä¶
-                .range([0, 200]);
+                .range([0, 40]);</code></pre>
<p>On inverse la courbe des <code>y</code> car en SVG, l'axe des <code>y</code> est tourn√© vers le bas :</p>
<pre><code>          y ‚Ä¶
-                .range([0, 400]);
+                .range([400, 0]);</code></pre>
<h2 id="ajout-des-axes-l√©gendes">13. Ajout des axes, l√©gendes‚Ä¶</h2>
<p>D3 offre un module pour cr√©er les axes (<a href="page12.html"><code>page12.html</code></a>); cela √©vite un travail fastidieux, d'autant que ces fonctions utilisent directement les √©chelles <code>d3.scale.‚Ä¶</code> pour avoir les bons r√©glages !</p>
<p>R√©f√©rence: <a href="https://github.com/d3/d3/wiki/SVG-Axes">SVG-Axes</a></p>
<p>Pr√©voir le style de nos axes :</p>
<pre><code>&lt;style&gt;
        .axis path {
            stroke: black;
            fill: none;
        }
        .tick line {
            stroke: #444;
        }
        .tick text {
            font-size: x-small;
        }
        text {
            font-size: smaller;
        }
&lt;/style&gt;</code></pre>
<p>cr√©er l'axe des <code>y</code>:</p>
<pre><code>var yAxis = d3.svg.axis()
    .scale(y)
    .ticks(8)
    .orient(&quot;left&quot;)</code></pre>
<p>et l'appliquer sur le graphe</p>
<pre><code>.append(&quot;g&quot;)
    .attr(&quot;class&quot;, &quot;y axis&quot;)
    .attr(&quot;transform&quot;, &quot;translate(0,0)&quot;)
    .call(yAxis)</code></pre>
<p>et pour finir, ajouter et positionner le nom des axes:</p>
<pre><code>.append(&#39;text&#39;)
    .text(&#39;PIB par habitant&#39;)
    .attr(&#39;transform&#39;, &#39;translate(640,-8)&#39;)
    .attr(&#39;text-anchor&#39;, &#39;end&#39;)</code></pre>
<h3 id="param√©trer-le-graphe">14. Param√©trer le graphe</h3>
<p>Essayons maintenant de changer la valeur de la variable <code>t</code>: <code>var t = 1950;</code> et <code>var t = 2015;</code> nous donnent des graphes tr√®s diff√©rents.</p>
<p>On va rendre cela param√©trable depuis la page (<a href="page13.html"><code>page13.html</code></a>).</p>
<p>Tout d'abord, cela implique de d√©finir un nouvel ¬´¬†√©tat¬†¬ª de l'information. Le plus simple est que cet √©tat soit d√©fini comme l'√©tat d'un √©l√©ment de la page. L'√©l√©ment le plus indiqu√© est un <em>slider</em> (thermom√®tre ou tirette).</p>
<pre><code>&lt;input type=range value=&quot;2015&quot; min=&quot;1950&quot; max=&quot;2015&quot; step=&quot;1&quot;&gt;</code></pre>
<p>et on lit sa valeur comme suit :</p>
<pre><code>d3.select(&quot;input[type=range]&quot;)[0].value</code></pre>
<p>On met tout cela dans deux fonctions qui nous permettent de ne plus nous en soucier. La premi√®re, qui ajoute le slider √† la page, la seconde qui renvoie sa valeur.</p>
<pre><code>d3.select(&#39;body&#39;)
    .append(&#39;div&#39;)
    .html(&#39;&lt;input type=range value=2015 min=1950 max=2015 step=1&gt;&#39;);
function annee() {
    return d3.select(&quot;input&quot;)[0][0].value;
}</code></pre>
<p>Avec un peu de CSS en plus, et une fonction qui rel√®ve le changement d'√©tat et l'affiche, on a d√©sormais une tirette qui affiche l'ann√©e !</p>
<h1 id="reformatage-du-code">15. Reformatage du code</h1>
<p>Il s'agit maintenant de mettre √† jour les donn√©es en fonction de l'ann√©e courante.</p>
<p>Pour cela, il faut reprendre tout le code et isoler ce qui sert la premi√®re fois (cr√©ation des bulles), de ce qui sert en permanence (mise en place des variables visuelles de chacun des bulles).</p>
<p>Ce reformatage est une op√©ration moins difficile qu'il n'y para√Æt, mais il faut bien prendre garde √† ne changer que ce qui dot changer. Ici les axes vont rester fixes, les bulles doivent changer de place et de forme, mais conserver la m√™me couleur (<a href="page14.html"><code>page14.html</code></a>).</p>
<p>Une difficult√© particuli√®re est que les ann√©es ne poss√®dent pas toutes des donn√©es associ√©es. Il faut donc dans ces cas-l√† prendre des valeurs proches üå∂.</p>
<pre><code>    function valeur(d, t) {
       var c, c1, c2;
       for (var i in d) {
           c = nombre(d[i]);
           if (c &amp;&amp; i == t) return c;
           if (c &amp;&amp; i &lt; t) c1 = c;
           if (c &amp;&amp; i &gt; t &amp;&amp; !c2) c2 = c;
       }
       return c1 &amp;&amp; c2 ? (c1+c2)/2 : c1 ? c1 : c2;
    }</code></pre>
<h1 id="animation-automatique">16. Animation automatique</h1>
<p>En cliquant sur la date, on va d√©clencher une animation automatique de la barre des dates, qu'on suspendra d√®s que l'utilisateur recliquera sur la tirette ou sur la date (<a href="page15.html"><code>page15.html</code></a>).</p>
<p>On en profite pour faire quelques r√©glages suppl√©mentaires :</p>
<ul>
<li><p>un l√©ger filet blanc autour des ronds (en CSS)</p>
<pre><code>circle {
stroke: white;
stroke-width: 0.6;
}</code></pre></li>
<li><p>on trie les pays par population d√©croissante, de mani√®re √† ce qu'on petit ne soit pas √©clips√© par un gros</p>
<pre><code>data.sort(function(a,b) {
return d3.descending(a.pop, b.pop);
});</code></pre></li>
</ul>
<h1 id="ajout-de-tooltips">17. Ajout de tooltips</h1>
<p>On utilise le plugin <code>d3-tip</code> pour cr√©er des bulles au survol (<a href="page16.html"><code>page16.html</code></a>).</p>
<pre><code>&lt;script src=&quot;./d3-tip.js&quot;&gt;&lt;/script&gt;
var tip = d3.tip()
    .attr(&#39;class&#39;, &#39;d3-tip&#39;)
    .offset([-10, 0])
    .html(function (d) {
        return d.nom;
    });
d3.select(&#39;svg&gt;g&#39;).call(tip);</code></pre>
<p>Le code qui le d√©clenche est ajout√© aux bulles apr√®s leur cr√©ation (dans la partie <code>.enter</code>) :</p>
<pre><code>    pays
        .on(&#39;mouseover&#39;, tip.show)
        .on(&#39;mouseout&#39;, tip.hide);</code></pre>
<h1 id="ajout-dune-ligne-de-temps">18. Ajout d'une ligne de temps</h1>
<p>On cr√©e une ligne vide, et une fonction qui lui donne sa forme entre les dates 1960 et 2015 (<a href="page17.html"><code>page17.html</code></a>).</p>
<pre><code>    d3.select(&#39;svg&gt;g&#39;)
        .append(&#39;path&#39;)
        .attr(&#39;class&#39;, &#39;timeline&#39;);

    function create_line(d) {
        var l = line(d);
        d3.selectAll(&#39;path.timeline&#39;)
            .transition()
            .attr(&#39;d&#39;, l(d3.range(1960-1, 2015+1)));
    }
    
    var line = function (d) {
        return d3.line()
            .x(function (t) {
                return x(valeur(d.richesse, t));
            })
            .y(function (t) {
                return y(valeur(d.sante, t));
            })
            .curve(d3.curveBasis);
    }
</code></pre>
<p>et au survol d'un pays, on appelle cette fonction :</p>
<pre><code>    .on(&#39;mouseover&#39;, function (d) {
        tip.show(d);
        create_line(d);
     })</code></pre>
<h1 id="toutes-les-lignes-de-temps">19. Toutes les lignes de temps</h1>
<p>Une variante consiste √† afficher plusieurs lignes de temps, mais si on en met trop √ßa devient illisible (<a href="page18.html"><code>page18.html</code></a>).</p>
<pre><code>pays.each(create_line);</code></pre>
<p>Par contre si on colore les lignes de temps avec la couleur du pays, et si on ajuste le rayon des bulles (<code>'r': 2.5</code>), on obtient une visualisation assez int√©ressante. (<a href="page19.html"><code>page19.html</code></a>).</p>
<p>On dispose maintenant d'une base pour tester toutes sortes de designs graphiques et pour interroger nos donn√©es.</p>
<h1 id="conclusion">20. Conclusion</h1>
<p>Ce parcours dans le code d'un exemple <code>d3.js</code> ne fait que montrer une possibilit√© graphique parmi les tr√®s nombreuses offertes par cet outil de programmation.</p>
<p>Le plus important est de comprendre qu'il existe des m√©thodes de repr√©sentation visuelle qui sont fond√©es scientifiquement, dont on sait qu'elles sont efficaces pour communiquer aupr√®s du public, efficaces aussi pour manipuler les donn√©es de fa√ßon interactive √† l'√©cran, avec un retour imm√©diat ; ces approches permettent aussi de trouver de nouvelles intuitions. Un observateur avis√© dot√© des bons outils trouvera de nouvelles questions √† se poser, de nouveaux sujets √† creuser, de nouvelles repr√©sentations √† formuler.</p>
<p>La m√©thodologie et le code vont ensemble, main dans la main, et d3.js est cod√© de fa√ßon √† permettre de respecter les bonnes m√©thodes. Qui plus est, il est assez versatile pour permettre de faire de belles visualisations, sur un plan esth√©tique.</p>
<p>Par le truchement des formats CSV et SVG, une d√©veloppeuse, une journaliste et une artiste / graphiste habitu√©e √† des outils de dessin vectoriel peut travailler ensemble de fa√ßon tr√®s fluide et constructive. C'est ce que je vous souhaite !</p>
<h2 id="pour-aller-plus-loin">Pour aller plus loin</h2>
<ul>
<li>traitement de donn√©es avec D3 http://learnjsdata.com/</li>
<li>Gapminder data https://www.gapminder.org/data/</li>
<li>pokeapi https://pokeapi.co/</li>
<li>cr√©er un fichier de donn√©es unique avec toutes les ann√©es m√™me manquantes</li>
<li>positionner l'ann√©e en bonne vue</li>
<li>travailler sur les baisses fortes (les mettre en √©vidence, les relier √† l'histoire : guerres, √©pid√©mie, famine‚Ä¶)</li>
</ul>

<script src="theme.js"></script>
</html>